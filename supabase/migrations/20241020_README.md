# Fix: insert_vote_do_nothing search_path Security Issue

## Overview

This migration fixes a security vulnerability in the `public.insert_vote_do_nothing` PostgreSQL function. The function was created without an explicit `SET search_path`, which allows callers to influence name resolution through their session's `search_path` setting.

## Files

1. **`20241020_fix_insert_vote_do_nothing_search_path.sql`** - Main migration file
2. **`20241020_discover_function_signature.sql`** - Discovery script (run first)
3. **`20241020_test_insert_vote_do_nothing.sql`** - Test script (run after migration)
4. **`20241020_DEPLOYMENT_CHECKLIST.md`** - Detailed deployment checklist

## Quick Start

### Step 1: Discover Current Function

Run the discovery script to see the actual function signature:

```sql
-- Execute in Supabase SQL Editor
\i supabase/migrations/20241020_discover_function_signature.sql
```

**Save the output** - especially the full function definition for rollback purposes.

### Step 2: Adjust Migration (if needed)

If the function signature differs from what's in the migration file, update:
- Parameter names and types in `CREATE OR REPLACE FUNCTION`
- Function body logic (if different)
- `SECURITY DEFINER` vs `SECURITY INVOKER` (check the discovery output)

### Step 3: Run Migration

```sql
-- Execute in Supabase SQL Editor
\i supabase/migrations/20241020_fix_insert_vote_do_nothing_search_path.sql
```

### Step 4: Run Tests

```sql
-- Execute in Supabase SQL Editor
\i supabase/migrations/20241020_test_insert_vote_do_nothing.sql
```

Review all NOTICE messages - all tests should pass.

## What This Fix Does

✅ **Adds explicit `SET search_path = public, pg_catalog`**
- Prevents callers from influencing name resolution
- Ensures function always resolves objects correctly

✅ **Fully qualifies all object references**
- `public.vote` instead of `vote`
- `public.gen_random_uuid()` if used (though table DEFAULT handles this)

✅ **Maintains existing behavior**
- Function still performs `INSERT ... ON CONFLICT DO NOTHING`
- Return type and parameters unchanged (unless you adjust them)

## Assumed Function Signature

The migration assumes this signature:

```sql
CREATE FUNCTION insert_vote_do_nothing(
  p_poll_id UUID,
  p_nullifier_hash TEXT,
  p_option_idx INTEGER
) RETURNS void
```

**If your function differs**, update the migration file before running.

## Security Notes

### SECURITY INVOKER (Default in Migration)

The migration uses `SECURITY INVOKER`, meaning the function runs with the caller's privileges. This is generally safer.

### If Function Uses SECURITY DEFINER

If the discovery script shows `SECURITY DEFINER`, update the migration:

```sql
CREATE OR REPLACE FUNCTION public.insert_vote_do_nothing(...)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER  -- Add this line
SET search_path = public, pg_catalog
AS $$ ... $$;
```

**Important**: With `SECURITY DEFINER`, ensure:
- Function owner has minimal required privileges
- Function body doesn't allow SQL injection
- No untrusted code paths exist

## Rollback

If issues occur:

1. Use the function definition saved from Step 1 (discovery script)
2. Execute it in Supabase SQL Editor to restore the original function
3. Verify with: `SELECT pg_get_functiondef(...)`

## Verification

After deployment, verify the fix:

```sql
-- Should return has_search_path = true
SELECT 
  pg_get_functiondef(p.oid) LIKE '%SET search_path%' AS has_search_path,
  pg_get_functiondef(p.oid) LIKE '%public, pg_catalog%' AS has_correct_path
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public' 
  AND p.proname = 'insert_vote_do_nothing';
```

## Related Security Issues

This fix addresses Supabase linter warning:
- **Error**: `role-mutable search_path`
- **Category**: Security
- **Severity**: High

After applying this fix, the function should no longer appear in security linter warnings.

## Support

If you encounter issues:
1. Check the discovery script output to verify function signature
2. Review the test script output for specific failures
3. Ensure all object references in function body are fully qualified
4. Verify `search_path` includes `pg_catalog` (for built-in functions)

